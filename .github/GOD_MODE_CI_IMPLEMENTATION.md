# God Mode CI - Security Hardening Implementation

## Overview

This document describes the "God Mode CI" security hardening features implemented in NIJA. These features represent next-level security practices typically found in enterprise and regulated environments.

## Implemented Features

### 1️⃣ Artifact Scanning

Comprehensive scanning of all build artifacts and container images.

#### Docker Image Scanning

**Tools**:
- **Trivy**: Industry-standard vulnerability scanner
  - Scans for CRITICAL and HIGH severity vulnerabilities
  - Generates SARIF reports for GitHub Security
  - Scans all Dockerfiles: main, API, dashboard, gateway

- **Grype**: Anchore's vulnerability scanner
  - Complementary scanning for broader coverage
  - Alternative vulnerability database
  - Reduces false negatives through redundancy

**Workflow**: `.github/workflows/artifact-scanning.yml`

**Coverage**:
- Base images and all layers
- Installed OS packages
- Application dependencies
- Known CVEs and security advisories

#### Python Package Scanning

**Tools**:
- **pip-audit**: Official Python vulnerability scanner
  - Checks against PyPI advisory database
  - Scans installed packages for known vulnerabilities
  - JSON report generation

- **GuardDog**: Malicious package detection
  - Identifies suspicious packages
  - Detects typosquatting
  - Checks for known malicious patterns

#### Build Artifact Validation

**Features**:
- SBOM (Software Bill of Materials) generation
  - CycloneDX format
  - Complete dependency tree
  - License information

- Wheel integrity verification
  - Structure validation
  - Content verification

- License compliance checking
  - Identifies all package licenses
  - Flags GPL/AGPL copyleft licenses
  - Generates compliance reports

**Reports Generated**:
- `pip-audit-report.json`
- `guarddog-report.json`
- `sbom.json`
- `licenses-report.json`
- `licenses-report.md`

### 2️⃣ Pre-Commit Secret Hooks

Prevents secrets from ever reaching GitHub by catching them at commit time.

#### Installation

```bash
# Install pre-commit
pip install pre-commit

# Install git hooks
cd /path/to/Nija
pre-commit install

# Run manually on all files
pre-commit run --all-files
```

#### Installed Hooks

**Secret Detection** (4 layers):
1. **detect-secrets**: Baseline-driven detection
   - Fast scanning
   - Low false positives
   - Maintains `.secrets.baseline`

2. **gitleaks**: Comprehensive scanning
   - Organization-wide configuration
   - Custom NIJA-specific patterns
   - Uses `.gitleaks.toml`

3. **trufflehog**: Verified secrets only
   - Advanced pattern matching
   - Reduces false positives
   - Only reports verified secrets

4. **detect-private-key**: SSH/PEM detection
   - Catches private keys
   - Prevents certificate commits

5. **detect-aws-credentials**: AWS-specific
   - AWS access keys
   - AWS secret keys

**Custom NIJA Checks**:
1. **check-env-files**: Blocks `.env` commits
2. **check-api-keys**: Detects hardcoded API keys
3. **check-pem-files**: Blocks certificate files

**Code Quality**:
- Bandit (Python security linting)
- Trailing whitespace
- End-of-file fixing
- YAML/JSON syntax validation
- Large file detection (>5MB)
- Merge conflict detection
- Python AST validation

#### Configuration Files

- `.pre-commit-config.yaml`: Hook configuration
- `.secrets.baseline`: Known false positives
- `.bandit.yml`: Python security rules
- `.gitleaks.toml`: Secret scanning rules

#### Usage

**Automatic** (after installation):
```bash
git commit -m "My changes"
# Hooks run automatically
```

**Manual**:
```bash
# Run all hooks
pre-commit run --all-files

# Run specific hook
pre-commit run gitleaks --all-files
pre-commit run bandit --all-files
```

**Emergency bypass** (use sparingly):
```bash
git commit --no-verify -m "Emergency fix"
```

### 3️⃣ Organization-Wide Secret Policy

Centralized rules and enforcement across all NIJA projects.

#### Configuration Files

**`.gitleaks.toml`** - Organization-wide rules:
- Custom patterns for trading APIs
  - Coinbase API keys/secrets
  - Kraken API keys/secrets
  - Alpaca API keys/secrets
  - TradingView webhook secrets
- Database passwords
- Encryption keys (Fernet)
- JWT secrets
- SSH private keys
- PEM certificates

**Allowlist**:
- Template files (`.env.example`, etc.)
- Documentation files
- Archive directory
- Dependencies

**`.secrets.baseline`** - Known false positives:
- Generated by scanning repository
- Updated when legitimate patterns flagged
- Requires review before update

**`.bandit.yml`** - Python security:
- Security issue detection
- Project-specific configuration
- Excludes test files and archives

#### Enforcement Layers

**Layer 1**: Developer Machine
- Pre-commit hooks
- Immediate feedback
- Blocks before commit

**Layer 2**: CI/CD Pipeline
- GitHub Actions workflows
- Cannot be bypassed
- Runs on all PRs and pushes

**Layer 3**: GitHub Native
- Built-in secret scanning
- Partner patterns
- Continuous monitoring

**Layer 4**: Artifact Scanning
- Build-time validation
- Container image scanning
- Dependency scanning

#### Policy Documentation

**Main Policy**: `.github/SECRET_SCANNING_POLICY.md`
- Complete policy definition
- Enforcement procedures
- Incident response
- Developer requirements
- Compliance checklist

**Setup Guide**: `.github/PRE_COMMIT_SETUP.md`
- Installation instructions
- Usage examples
- Troubleshooting
- Best practices

**Security Updates**: `SECURITY.md` (updated)
- God Mode CI section
- Security scanning matrix
- Incident response
- Compliance checklist

## Security Scanning Matrix

| Scanner | Layer | Frequency | Coverage | Blocking |
|---------|-------|-----------|----------|----------|
| detect-secrets | Pre-commit + CI | Every commit | Baseline-driven | Yes (pre-commit) |
| gitleaks | Pre-commit + CI | Every commit + Weekly | Comprehensive | Yes (pre-commit) |
| trufflehog | Pre-commit + CI | Every commit + Weekly | Verified only | No (warning) |
| GitHub Secret Scanning | Native | Continuous | Partner patterns | Alert only |
| Trivy | CI | On build + Weekly | Docker images | No (report only) |
| Grype | CI | On build | Docker images | No (report only) |
| pip-audit | CI | Every build | Python packages | No (warning) |
| GuardDog | CI | Every build | Malicious packages | No (warning) |
| Bandit | Pre-commit + CI | Every commit | Python security | Yes (pre-commit) |

## Workflows

### Artifact Scanning Workflow

**File**: `.github/workflows/artifact-scanning.yml`

**Jobs**:
1. `docker-image-scan`: Scan all Docker images
2. `python-package-scan`: Scan Python dependencies
3. `build-artifact-scan`: Validate build artifacts
4. `dependency-license-scan`: Check license compliance

**Triggers**:
- Push to main/develop
- Pull requests to main
- Weekly schedule (Mondays 3am UTC)

### Enhanced Security Scan Workflow

**File**: `.github/workflows/security-scan.yml` (updated)

**Jobs**:
1. `dependency-scan`: Safety check (existing)
2. `secrets-scan`: Multi-tool secret scanning (enhanced)
3. `bandit-scan`: Python security (existing)
4. `pre-commit-checks`: Validate pre-commit hooks (new)

**Enhancements**:
- Added Gitleaks with custom config
- Added detect-secrets baseline validation
- Added pre-commit hook validation
- Improved reporting

## Usage Examples

### For Developers

**Daily Workflow**:
```bash
# 1. Install pre-commit (one time)
pip install pre-commit
pre-commit install

# 2. Make changes
git add .

# 3. Commit (hooks run automatically)
git commit -m "feat: add new feature"

# 4. If hooks fail, fix and retry
# Fix the issues, then:
git add .
git commit -m "feat: add new feature"
```

**Handling False Positives**:
```bash
# If legitimate code flagged as secret
detect-secrets scan > .secrets.baseline
git add .secrets.baseline
git commit -m "Update secrets baseline"
```

### For Security Team

**Weekly Security Review**:
```bash
# Check artifact scanning results
gh run list --workflow=artifact-scanning.yml

# Download reports
gh run download <run-id>

# Review SARIF files in GitHub Security tab
```

**Incident Response**:
```bash
# If secret detected in history
gitleaks detect --source . --verbose

# Remove from history
git filter-branch --force --index-filter \
  "git rm --cached --ignore-unmatch PATH-TO-FILE" \
  --prune-empty --tag-name-filter cat -- --all
```

## Benefits

### Security Benefits

✅ **Defense in Depth**
- Multiple layers of protection
- Redundant scanning tools
- Cannot bypass without awareness

✅ **Early Detection**
- Secrets caught at commit time
- Before they reach GitHub
- Before they're in history

✅ **Comprehensive Coverage**
- Source code
- Container images
- Dependencies
- Build artifacts
- Certificates and keys

✅ **Compliance Ready**
- Complete audit trail
- SBOM generation
- License compliance
- Policy enforcement

### Developer Benefits

✅ **Immediate Feedback**
- Hooks run locally
- Instant error messages
- Clear fix guidance

✅ **Reduced Incidents**
- Prevents accidental commits
- Catches mistakes early
- Protects developers

✅ **Better Habits**
- Trains secure practices
- Automated enforcement
- Consistent standards

### Project Benefits

✅ **Risk Reduction**
- Prevents credential leaks
- Reduces vulnerability exposure
- Protects trading capital

✅ **Professional Grade**
- Enterprise-level security
- Industry best practices
- Audit-ready compliance

✅ **Continuous Improvement**
- Weekly scans catch drift
- Automated updates
- Regular policy reviews

## Maintenance

### Regular Tasks

**Weekly**:
- Review artifact scan results
- Check for new vulnerabilities
- Update dependencies if needed

**Monthly**:
- Update pre-commit hooks: `pre-commit autoupdate`
- Review and update `.secrets.baseline`
- Check `.gitleaks.toml` for new patterns

**Quarterly**:
- Review and update SECRET_SCANNING_POLICY.md
- Audit enforcement effectiveness
- Update Bandit rules if needed

**Annually**:
- Complete security audit
- Update all configurations
- Review and improve policies

### Updating Configurations

**Pre-commit hooks**:
```bash
pre-commit autoupdate
git add .pre-commit-config.yaml
git commit -m "chore: update pre-commit hooks"
```

**Secrets baseline**:
```bash
detect-secrets scan > .secrets.baseline
git add .secrets.baseline
git commit -m "chore: update secrets baseline"
```

**Gitleaks rules**:
```bash
# Edit .gitleaks.toml
vim .gitleaks.toml
git add .gitleaks.toml
git commit -m "chore: update gitleaks rules"
```

## Troubleshooting

### Common Issues

**Pre-commit hooks slow**:
- First run installs dependencies (slow)
- Subsequent runs are cached (fast)
- Skip slow hooks during development: `SKIP=trufflehog git commit`

**False positives**:
- Add to `.secrets.baseline` for detect-secrets
- Add to allowlist in `.gitleaks.toml`
- Document why it's a false positive

**Hooks not running**:
```bash
# Reinstall hooks
pre-commit clean
pre-commit install --install-hooks
```

**CI failures**:
- Check workflow logs in GitHub Actions
- Download artifact reports
- Fix locally before pushing

## Resources

### Documentation

- [SECRET_SCANNING_POLICY.md](.github/SECRET_SCANNING_POLICY.md) - Complete policy
- [PRE_COMMIT_SETUP.md](.github/PRE_COMMIT_SETUP.md) - Setup guide
- [SECURITY.md](SECURITY.md) - Security documentation

### Tools

- [Trivy](https://github.com/aquasecurity/trivy) - Container scanner
- [Grype](https://github.com/anchore/grype) - Vulnerability scanner
- [Gitleaks](https://github.com/gitleaks/gitleaks) - Secret scanner
- [detect-secrets](https://github.com/Yelp/detect-secrets) - Baseline scanner
- [TruffleHog](https://github.com/trufflesecurity/trufflehog) - Verified secrets
- [Bandit](https://github.com/PyCQA/bandit) - Python security
- [pre-commit](https://pre-commit.com/) - Git hooks framework

### External Resources

- [OWASP Secrets Management](https://cheatsheetseries.owasp.org/cheatsheets/Secrets_Management_Cheat_Sheet.html)
- [GitHub Security Best Practices](https://docs.github.com/en/code-security)
- [NIST Cybersecurity Framework](https://www.nist.gov/cyberframework)

## Support

**Questions or Issues?**
- Check troubleshooting section above
- Review policy documentation
- Open GitHub issue
- Contact: security@nija.example.com

---

**Version**: 1.0
**Last Updated**: January 29, 2026
**Status**: ✅ Fully Implemented and Operational
