name: Artifact Scanning

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run weekly on Mondays at 3am UTC
    - cron: '0 3 * * 1'

jobs:
  docker-image-scan:
    name: Docker Image Security Scan
    runs-on: ubuntu-latest
    strategy:
      matrix:
        dockerfile: [Dockerfile, Dockerfile.api, Dockerfile.dashboard, Dockerfile.gateway]

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Extract image name from dockerfile
      id: image-name
      run: |
        DOCKERFILE="${{ matrix.dockerfile }}"
        if [ "$DOCKERFILE" = "Dockerfile" ]; then
          echo "image=nija:latest" >> $GITHUB_OUTPUT
        else
          SUFFIX=$(echo $DOCKERFILE | sed 's/Dockerfile\.//')
          echo "image=nija-${SUFFIX}:latest" >> $GITHUB_OUTPUT
        fi

    - name: Build Docker image
      env:
        GH_TOKEN: ${{ secrets.GH_TOKEN }}
      run: |
        docker build --no-cache \
          --build-arg GH_TOKEN="${GH_TOKEN}" \
          -f ${{ matrix.dockerfile }} \
          -t ${{ steps.image-name.outputs.image }} \
          .

    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: ${{ steps.image-name.outputs.image }}
        format: 'sarif'
        output: 'trivy-results-${{ matrix.dockerfile }}.sarif'
        severity: 'CRITICAL,HIGH'
        exit-code: '0'  # Don't fail build, just report

    - name: Upload Trivy results to GitHub Security
      uses: github/codeql-action/upload-sarif@v3
      if: always()
      with:
        sarif_file: 'trivy-results-${{ matrix.dockerfile }}.sarif'
        category: 'trivy-${{ matrix.dockerfile }}'

    - name: Run Trivy vulnerability scanner (table format)
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: ${{ steps.image-name.outputs.image }}
        format: 'table'
        severity: 'CRITICAL,HIGH,MEDIUM'
        exit-code: '0'

    - name: Run Grype vulnerability scanner
      uses: anchore/scan-action@v3
      id: grype-scan
      with:
        image: ${{ steps.image-name.outputs.image }}
        fail-build: false
        severity-cutoff: high

    - name: Upload Grype scan results
      uses: github/codeql-action/upload-sarif@v3
      if: always()
      with:
        sarif_file: ${{ steps.grype-scan.outputs.sarif }}
        category: 'grype-${{ matrix.dockerfile }}'

  python-package-scan:
    name: Python Package Security Scan
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Run pip-audit for vulnerability scanning
      run: |
        pip install pip-audit
        pip-audit --desc --output pip-audit-report.json --format json || true
        pip-audit --desc || echo "::warning::Vulnerabilities found in Python packages"

    - name: Upload pip-audit report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: pip-audit-report
        path: pip-audit-report.json

    - name: Scan for malicious packages with PyPI Guardian
      run: |
        pip install guarddog
        guarddog pypi scan requirements.txt --output-format json --exit-non-zero-on-finding 2>&1 | tee guarddog-report.json || echo "::warning::Suspicious packages detected"
      continue-on-error: true

    - name: Upload GuardDog report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: guarddog-report
        path: guarddog-report.json

  build-artifact-scan:
    name: Build Artifact Integrity Check
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Build Python package
      run: |
        python -m pip install --upgrade pip setuptools wheel build
        # Create a minimal setup.py if it doesn't exist
        if [ ! -f setup.py ]; then
          cat > setup.py << 'SETUPEOF'
        from setuptools import setup, find_packages
        setup(
            name="nija",
            version="1.0.0",
            packages=find_packages(),
            install_requires=[line.strip() for line in open('requirements.txt')],
        )
        SETUPEOF
        fi
        python -m build --wheel --sdist

    - name: Generate SBOM (Software Bill of Materials)
      run: |
        pip install cyclonedx-bom
        cyclonedx-py --requirements requirements.txt -o sbom.json --format json

    - name: Upload SBOM
      uses: actions/upload-artifact@v4
      with:
        name: software-bill-of-materials
        path: sbom.json

    - name: Verify wheel integrity
      run: |
        pip install check-wheel-contents
        find dist -name "*.whl" -exec check-wheel-contents {} \; || echo "::warning::Wheel integrity issues detected"
      continue-on-error: true

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: python-build-artifacts
        path: dist/

  dependency-license-scan:
    name: License Compliance Check
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Check licenses with pip-licenses
      run: |
        pip install pip-licenses
        pip-licenses --format=json --output-file=licenses-report.json
        pip-licenses --format=markdown --output-file=licenses-report.md
        echo "::group::License Summary"
        pip-licenses
        echo "::endgroup::"

    - name: Upload license reports
      uses: actions/upload-artifact@v4
      with:
        name: license-reports
        path: |
          licenses-report.json
          licenses-report.md

    - name: Check for GPL/AGPL licenses (strict copyleft)
      run: |
        pip install pip-licenses
        COPYLEFT=$(pip-licenses --format=csv | grep -iE "GPL|AGPL" || echo "")
        if [ ! -z "$COPYLEFT" ]; then
          echo "::warning::Strict copyleft licenses detected:"
          echo "$COPYLEFT"
        else
          echo "No strict copyleft licenses detected."
        fi
