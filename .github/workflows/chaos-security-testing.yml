name: Chaos Security Testing

on:
  schedule:
    # Run chaos tests weekly on Saturdays at 1am UTC
    - cron: '0 1 * * 6'
  workflow_dispatch:
    inputs:
      chaos_type:
        description: 'Type of chaos experiment'
        required: true
        type: choice
        options:
          - all
          - network
          - auth
          - api
          - database
      duration_seconds:
        description: 'Duration of chaos experiment (seconds)'
        required: false
        default: '300'

jobs:
  network-chaos:
    name: Network Failure Injection
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.chaos_type == 'all' || github.event.inputs.chaos_type == 'network' || github.event_name == 'schedule' }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest toxiproxy-py requests-mock

    # Test network latency resilience
    - name: Test API Latency Resilience
      run: |
        python scripts/chaos/test_network_latency.py \
          --latency-ms 1000 \
          --duration ${{ github.event.inputs.duration_seconds || '300' }}
      continue-on-error: true

    # Test network failure resilience
    - name: Test Network Failure Resilience
      run: |
        python scripts/chaos/test_network_failure.py \
          --failure-rate 0.3 \
          --duration ${{ github.event.inputs.duration_seconds || '300' }}
      continue-on-error: true

    # Test timeout handling
    - name: Test Timeout Resilience
      run: |
        python scripts/chaos/test_timeout_resilience.py \
          --timeout-seconds 5 \
          --duration ${{ github.event.inputs.duration_seconds || '300' }}
      continue-on-error: true

    - name: Upload Network Chaos Results
      uses: actions/upload-artifact@v4.4.3
      if: always()
      with:
        name: network-chaos-results
        path: chaos-results/network/

  auth-chaos:
    name: Authentication Chaos Testing
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.chaos_type == 'all' || github.event.inputs.chaos_type == 'auth' || github.event_name == 'schedule' }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest

    # Test expired token handling
    - name: Test Expired Token Handling
      run: |
        python scripts/chaos/test_expired_tokens.py
      continue-on-error: true

    # Test invalid credentials
    - name: Test Invalid Credentials Resilience
      run: |
        python scripts/chaos/test_invalid_credentials.py
      continue-on-error: true

    # Test concurrent authentication failures
    - name: Test Concurrent Auth Failures
      run: |
        python scripts/chaos/test_concurrent_auth_failures.py \
          --concurrent-requests 100
      continue-on-error: true

    - name: Upload Auth Chaos Results
      uses: actions/upload-artifact@v4.4.3
      if: always()
      with:
        name: auth-chaos-results
        path: chaos-results/auth/

  api-rate-limit-chaos:
    name: API Rate Limit Chaos
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.chaos_type == 'all' || github.event.inputs.chaos_type == 'api' || github.event_name == 'schedule' }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest locust

    # Test rate limit handling
    - name: Test API Rate Limit Handling
      run: |
        python scripts/chaos/test_rate_limit_resilience.py \
          --requests-per-second 1000
      continue-on-error: true

    # Test burst traffic
    - name: Test Burst Traffic Handling
      run: |
        python scripts/chaos/test_burst_traffic.py \
          --burst-size 10000 \
          --burst-duration 10
      continue-on-error: true

    - name: Upload API Chaos Results
      uses: actions/upload-artifact@v4.4.3
      if: always()
      with:
        name: api-chaos-results
        path: chaos-results/api/

  database-chaos:
    name: Database Chaos Testing
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.chaos_type == 'all' || github.event.inputs.chaos_type == 'database' || github.event_name == 'schedule' }}
    
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_DB: test_nija
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest

    # Test database connection failures
    - name: Test DB Connection Resilience
      run: |
        python scripts/chaos/test_db_connection_failure.py \
          --failure-rate 0.2
      env:
        DATABASE_URL: postgresql://test_user:test_password@localhost:5432/test_nija
      continue-on-error: true

    # Test slow queries
    - name: Test Slow Query Resilience
      run: |
        python scripts/chaos/test_slow_queries.py \
          --delay-ms 5000
      env:
        DATABASE_URL: postgresql://test_user:test_password@localhost:5432/test_nija
      continue-on-error: true

    # Test transaction rollback
    - name: Test Transaction Rollback Handling
      run: |
        python scripts/chaos/test_transaction_rollback.py
      env:
        DATABASE_URL: postgresql://test_user:test_password@localhost:5432/test_nija
      continue-on-error: true

    - name: Upload Database Chaos Results
      uses: actions/upload-artifact@v4.4.3
      if: always()
      with:
        name: database-chaos-results
        path: chaos-results/database/

  chaos-report:
    name: Generate Chaos Test Report
    runs-on: ubuntu-latest
    needs: [network-chaos, auth-chaos, api-rate-limit-chaos, database-chaos]
    if: always()
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Download all chaos results
      uses: actions/download-artifact@v4.1.3
      with:
        path: all-chaos-results

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Generate chaos test report
      run: |
        python -m pip install jinja2 markdown
        python scripts/generate_chaos_report.py \
          --results-dir all-chaos-results \
          --output CHAOS_TEST_REPORT.md
      continue-on-error: true

    - name: Upload consolidated chaos report
      uses: actions/upload-artifact@v4.4.3
      if: always()
      with:
        name: chaos-test-report
        path: CHAOS_TEST_REPORT.md
