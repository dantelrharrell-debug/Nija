name: Zero-Trust CI Isolation

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

# Strict permissions (least privilege)
permissions:
  contents: read
  
jobs:
  # Ephemeral runner setup
  setup-runner:
    name: Setup Isolated Runner
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write  # For OIDC authentication
    
    outputs:
      runner-id: ${{ steps.runner.outputs.id }}
      
    steps:
    - name: Generate Runner Token
      id: runner
      run: |
        RUNNER_ID=$(uuidgen)
        echo "id=${RUNNER_ID}" >> $GITHUB_OUTPUT
        echo "::notice::Created ephemeral runner: ${RUNNER_ID}"

  # Isolated build job
  build:
    name: Build with Zero-Trust Isolation
    runs-on: ubuntu-latest
    needs: setup-runner
    
    # Strict permissions
    permissions:
      contents: read
      packages: write
      id-token: write
    
    # Network isolation
    env:
      # Disable network access to internal services
      NO_PROXY: ""
      HTTP_PROXY: ""
      HTTPS_PROXY: ""
    
    steps:
    - name: Harden Runner (Network Egress Control)
      uses: step-security/harden-runner@v2
      with:
        egress-policy: block
        allowed-endpoints: >
          api.github.com:443
          github.com:443
          objects.githubusercontent.com:443
          registry.npmjs.org:443
          pypi.org:443
          files.pythonhosted.org:443

    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        persist-credentials: false  # Don't persist credentials

    - name: Set up Python (Isolated)
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    # Verify dependencies before install
    - name: Verify Dependencies Hash
      run: |
        sha256sum requirements.txt > requirements.txt.sha256
        echo "Dependency hash: $(cat requirements.txt.sha256)"

    - name: Install Dependencies (Isolated)
      run: |
        python -m pip install --upgrade pip
        # Install in isolated environment
        pip install --no-cache-dir --require-hashes -r requirements.txt || \
        pip install --no-cache-dir -r requirements.txt

    # Build in isolated environment
    - name: Build Application (Sandboxed)
      run: |
        # Run build in restricted environment
        python -c "import sys; print(f'Python: {sys.version}')"
        python -m compileall bot/
      env:
        PYTHONDONTWRITEBYTECODE: 1

    # Sign artifacts
    - name: Sign Build Artifacts
      if: github.event_name == 'push'
      run: |
        # Create artifact signature
        find bot/ -name "*.pyc" -type f -exec sha256sum {} \; > build-artifacts.sha256
        echo "::notice::Build artifacts signed"

    - name: Upload Build Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-artifacts-${{ github.sha }}
        path: |
          bot/
          build-artifacts.sha256
        retention-days: 7

  # Isolated security scan
  security-scan:
    name: Security Scan (Isolated)
    runs-on: ubuntu-latest
    needs: build
    
    permissions:
      contents: read
      security-events: write
      id-token: write
    
    steps:
    - name: Harden Runner
      uses: step-security/harden-runner@v2
      with:
        egress-policy: block
        allowed-endpoints: >
          api.github.com:443
          github.com:443

    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        persist-credentials: false

    - name: Download Build Artifacts
      uses: actions/download-artifact@v4
      with:
        name: build-artifacts-${{ github.sha }}
        path: build/

    # Verify artifact signatures
    - name: Verify Artifact Signatures
      run: |
        cd build
        sha256sum -c build-artifacts.sha256
        echo "::notice::Artifact signatures verified"

    - name: Run Security Scan in Sandbox
      run: |
        # Run security tools in isolated environment
        docker run --rm --network none \
          -v $(pwd):/scan \
          aquasec/trivy fs /scan

  # Isolated test execution
  test:
    name: Test (Isolated Environment)
    runs-on: ubuntu-latest
    needs: build
    
    permissions:
      contents: read
      id-token: write
    
    # Test matrix for isolation
    strategy:
      matrix:
        test-group: [unit, integration]
    
    steps:
    - name: Harden Runner
      uses: step-security/harden-runner@v2
      with:
        egress-policy: block
        allowed-endpoints: >
          api.github.com:443
          pypi.org:443
          files.pythonhosted.org:443

    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        persist-credentials: false

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Download Build Artifacts
      uses: actions/download-artifact@v4
      with:
        name: build-artifacts-${{ github.sha }}
        path: build/

    - name: Install Test Dependencies (Isolated)
      run: |
        python -m pip install --upgrade pip
        pip install pytest pytest-cov pytest-timeout

    # Run tests in isolated environment
    - name: Run ${{ matrix.test-group }} Tests (Sandboxed)
      run: |
        # Run tests with timeout and resource limits
        timeout 600 pytest -v \
          --timeout=60 \
          --cov=bot \
          --cov-report=xml \
          -k "${{ matrix.test-group }}"
      env:
        # Disable network for unit tests
        PYTEST_DISABLE_NETWORK: ${{ matrix.test-group == 'unit' && 'true' || 'false' }}

  # Cleanup ephemeral resources
  cleanup:
    name: Cleanup Isolated Resources
    runs-on: ubuntu-latest
    needs: [build, security-scan, test]
    if: always()
    
    permissions:
      contents: read
    
    steps:
    - name: Cleanup Artifacts
      uses: geekyeggo/delete-artifact@v2
      with:
        name: build-artifacts-${{ github.sha }}
        failOnError: false

    - name: Cleanup Complete
      run: |
        echo "::notice::Ephemeral resources cleaned up"
