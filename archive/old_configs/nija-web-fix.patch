From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: nija-bot <noreply@nija.local>
Date: Mon, 24 Nov 2025 21:30:00 +0000
Subject: [PATCH] web: add tradingview blueprint + wsgi app shim; set gunicorn loglevel

---
 .github/            |  0
 gunicorn.conf.py    | 16 ++++++++++++++--
 web/tradingview_webhook.py | 40 ++++++++++++++++++++++++++++++++++++++++
 web/wsgi.py         |107 +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
 4 files changed, 161 insertions(+), 2 deletions(-)
 create mode 100644 web/tradingview_webhook.py
 create mode 100644 web/wsgi.py

diff --git a/gunicorn.conf.py b/gunicorn.conf.py
index 0000000..0000000 100644
--- a/gunicorn.conf.py
+++ b/gunicorn.conf.py
@@ -1,16 +1,16 @@
 # --- Gunicorn configuration ---
 bind = "0.0.0.0:5000"
 workers = 1
 threads = 1
 worker_class = "sync"
 timeout = 30
 keepalive = 2
-loglevel = "debug"
+loglevel = "info"
 accesslog = "-"
 errorlog = "-"
-bind = "0.0.0.0:5000"
-workers = 1
-threads = 1
-timeout = 30
-loglevel = "debug"
+# duplicate lines removed; loglevel intentionally set to "info" for production
+
diff --git a/web/tradingview_webhook.py b/web/tradingview_webhook.py
new file mode 100644
index 0000000..1111111
--- /dev/null
+++ b/web/tradingview_webhook.py
@@ -0,0 +1,40 @@
+from flask import Blueprint, request, jsonify
+
+# blueprint name: 'tradingview_webhook'
+bp = Blueprint("tradingview_webhook", __name__)
+
+
+@bp.route("/webhook", methods=["POST"])
+def webhook():
+    """
+    Simple TradingView webhook receiver.
+    Receives POST JSON and returns 200 on success.
+    Keep logic minimal here and forward heavy work to background tasks if needed.
+    """
+    try:
+        payload = request.get_json(silent=True)
+        # quick logging for debugging in container logs
+        print("TradingView webhook received payload:", payload)
+
+        # TODO: validate webhook signature / secret here (recommended)
+        # Example:
+        # secret = os.environ.get("TV_WEBHOOK_SECRET")
+        # check request.headers or payload for secret
+
+        # Replace the following with actual processing logic
+        # (e.g. enqueue trade job, validate symbol, check risk, etc.)
+        return jsonify({"status": "ok", "received": bool(payload)}), 200
+    except Exception as exc:
+        print("TradingView webhook error:", exc)
+        return jsonify({"status": "error", "message": str(exc)}), 500
+
diff --git a/web/wsgi.py b/web/wsgi.py
new file mode 100644
index 0000000..2222222
--- /dev/null
+++ b/web/wsgi.py
@@ -0,0 +1,107 @@
+"""
+Minimal Flask WSGI application used by Gunicorn.
+- Registers the TradingView webhook blueprint at /tv
+- Provides a Coinbase shim that allows the app to run without the Coinbase client
+  being installed (safe for deployments without live trading enabled).
+"""
+from flask import Flask, jsonify, request
+import logging
+import os
+import sys
+
+logging.basicConfig(level=logging.INFO)
+logger = logging.getLogger(__name__)
+
+# Add vendor path for a vendored Coinbase client if present.
+# This keeps imports robust whether you pip-install the package or vendor it.
+VENDOR_COINBASE_PATH = os.path.join(os.path.dirname(__file__), "../vendor/coinbase_advanced_py")
+if os.path.isdir(VENDOR_COINBASE_PATH):
+    sys.path.insert(0, os.path.abspath(VENDOR_COINBASE_PATH))
+
+# Try to import the official client (if installed). If not present, we keep running.
+COINBASE_AVAILABLE = False
+try:
+    # import name here should match either installed package or your vendored module
+    from coinbase_advanced_py.client import Client as CoinbaseClient  # type: ignore
+    COINBASE_AVAILABLE = True
+    logger.info("Coinbase client import OK")
+except Exception:
+    try:
+        # Common alternative package name — tolerant attempt
+        from coinbase_advanced.client import Client as CoinbaseClient  # type: ignore
+        COINBASE_AVAILABLE = True
+        logger.info("Coinbase client (alt) import OK")
+    except Exception:
+        logger.warning("⚠️ Coinbase client not found — live trading disabled (shim active)")
+        CoinbaseClient = None  # type: ignore
+
+
+def create_app():
+    app = Flask(__name__)
+
+    @app.route("/health", methods=["GET"])
+    def health():
+        return "OK", 200
+
+    # Register TradingView blueprint (local explicit import to avoid circular import)
+    try:
+        from web.tradingview_webhook import bp as tradingview_bp
+        app.register_blueprint(tradingview_bp, url_prefix="/tv")
+        logger.info("✅ TradingView blueprint registered at /tv")
+    except Exception as exc:
+        logger.warning(f"⚠️ Could not register TradingView blueprint: {exc}")
+
+    # Minimal Coinbase init (non-fatal)
+    def init_coinbase():
+        if not COINBASE_AVAILABLE or CoinbaseClient is None:
+            logger.warning("⚠️ Coinbase client not present or failed to import; live trading disabled.")
+            return None
+
+        api_key = os.getenv("COINBASE_API_KEY")
+        api_secret = os.getenv("COINBASE_API_SECRET")
+        api_sub = os.getenv("COINBASE_API_SUB")
+
+        if not (api_key and api_secret and api_sub):
+            logger.warning("⚠️ Coinbase API credentials missing; skipping live setup.")
+            return None
+
+        try:
+            client = CoinbaseClient(api_key, api_secret, api_sub)
+            # Try a lightweight call if the client exposes one (non-exception)
+            try:
+                _ = client.get_accounts()  # may raise / return depending on client
+            except Exception:
+                # if the client doesn't support this method or it's heavy, ignore here
+                pass
+            logger.info("✅ Coinbase client initialized")
+            return client
+        except Exception as e:
+            logger.error(f"❌ Coinbase client initialization failed: {e}")
+            return None
+
+    # Attach coinbase client instance to app for downstream routes
+    app.coinbase_client = init_coinbase()
+
+    @app.route("/trade/status", methods=["GET"])
+    def trade_status():
+        if not getattr(app, "coinbase_client", None):
+            return jsonify({"status": "Coinbase not connected"}), 503
+        try:
+            accounts = app.coinbase_client.get_accounts()
+            return jsonify({"status": "live", "accounts": accounts}), 200
+        except Exception as exc:
+            logger.error("Error fetching Coinbase accounts: %s", exc)
+            return jsonify({"status": "error", "message": str(exc)}), 500
+
+    return app
+
+
+# Create `app` for Gunicorn to import (web.wsgi:app)
+app = create_app()
+
+# If run directly for local debug
+if __name__ == "__main__":
+    app.run(host="0.0.0.0", port=int(os.environ.get("PORT", "5000")), debug=False)
+
-- 
2.40.1
