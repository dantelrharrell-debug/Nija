# AppArmor profile for NIJA trading bot
# Provides mandatory access control for runtime security

#include <tunables/global>

profile nija-bot flags=(attach_disconnected,mediate_deleted) {
  #include <abstractions/base>
  #include <abstractions/python>
  #include <abstractions/openssl>
  #include <abstractions/ssl_certs>

  # Application binary
  /usr/bin/python3.11 ix,
  /usr/local/bin/python* ix,

  # Application files (read-only)
  /app/** r,
  /app/bot/** r,
  /app/*.py r,
  
  # Allow execution of Python bytecode
  /app/**/__pycache__/** r,
  /usr/lib/python3.11/** r,
  
  # Configuration files (read-only)
  /app/.env r,
  /app/config/** r,
  
  # Data directories (read-write for logs and cache)
  /app/cache/** rw,
  /app/data/** rw,
  /app/logs/** rw,
  /tmp/** rw,
  
  # Deny write access to code
  deny /app/bot/** w,
  deny /app/*.py w,
  deny /app/config/** w,
  
  # Network access (required for API calls)
  network inet stream,
  network inet dgram,
  network inet6 stream,
  network inet6 dgram,
  
  # DNS resolution
  /etc/resolv.conf r,
  /etc/hosts r,
  /etc/nsswitch.conf r,
  
  # SSL/TLS
  /etc/ssl/certs/** r,
  /usr/share/ca-certificates/** r,
  
  # System files (read-only)
  /etc/passwd r,
  /etc/group r,
  /proc/sys/kernel/random/uuid r,
  
  # Python runtime requirements
  /usr/lib/python3*/** r,
  /usr/local/lib/python3*/** r,
  
  # Deny dangerous capabilities
  deny capability sys_admin,
  deny capability sys_module,
  deny capability sys_rawio,
  deny capability sys_ptrace,
  deny capability dac_override,
  deny capability dac_read_search,
  
  # Deny sensitive system access
  deny /proc/kcore r,
  deny /proc/kallsyms r,
  deny /boot/** r,
  deny /sys/kernel/debug/** rw,
  
  # Deny access to other containers
  deny /var/lib/docker/** rw,
  deny /var/run/docker.sock rw,
}
