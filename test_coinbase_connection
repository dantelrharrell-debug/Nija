# --- Helper: test Coinbase connection (debug Advanced API) ---
def test_coinbase_connection_debug():
    """
    Test Spot and Advanced accounts, with detailed JWT debug info for Advanced API.
    """
    success_spot = success_adv = False

    # --- Spot ---
    try:
        fetch_accounts(advanced=False)
        logging.info("✅ Coinbase Spot connection verified.")
        success_spot = True
    except Exception as e:
        logging.error(f"❌ Coinbase Spot connection failed: {e}")

    # --- Advanced (debug) ---
    try:
        # Build JWT manually for debug
        path = f"/api/v3/brokerage/organizations/{COINBASE_ORG_ID}/accounts"
        iat = int(time.time())
        payload = {
            "iat": iat,
            "exp": iat + 120,
            "sub": COINBASE_API_SUB,  # check this value!
            "request_path": path,
            "method": "GET",
            "jti": f"nija-{iat}"
        }
        headers = {"alg": "ES256", "kid": COINBASE_API_KEY_ID}
        logging.info(f"Advanced JWT Payload: {payload}")
        logging.info(f"Advanced JWT Header: {headers}")

        token = jwt.encode(payload, private_key, algorithm="ES256", headers=headers)

        url = "https://api.coinbase.com" + path
        resp = requests.get(url, headers={
            "Authorization": f"Bearer {token}",
            "CB-VERSION": datetime.datetime.utcnow().strftime("%Y-%m-%d"),
            "Content-Type": "application/json"
        }, timeout=10)

        if resp.status_code == 200:
            logging.info("✅ Coinbase Advanced connection verified.")
            success_adv = True
        else:
            logging.warning(f"❌ Advanced API request failed: HTTP {resp.status_code} {resp.text}")

    except Exception as e:
        logging.error(f"❌ Coinbase Advanced connection exception: {e}")

    if not (success_spot and success_adv):
        logging.warning(f"Spot success={success_spot}, Advanced success={success_adv}")
    return success_spot and success_adv
